<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WebAR Maze - Pacman Style</title>

<!-- Tối ưu tải hình nền intro -->
<link rel="preload" as="image" href="Background.png">

<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }

  /* ===== MÀN HÌNH INTRO ===== */
  #introScreen {
    position: fixed;
    inset: 0;
    background-image: url('Background.png'); /* <<< Bạn thay hình nền intro ở đây */
    background-size: cover;
    background-position: center;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index: 10000;
  }
  #introScreen.hidden { display:none; }

  #startARBtn {
    padding:16px 40px;
    font-size:22px;
    border-radius:12px;
    border:none;
    cursor:pointer;
    background:white;
  }

  /* ===== NÚT ICON GÓC MÀN HÌNH ===== */
  .iconBtn {
    position: fixed;
    width:64px; height:64px; /* Nút to hơn */
    border:none; background:none;
    background-size:70%;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    z-index:10001;
  }

  #volumeBtn {
    top:16px; right:16px;
    background-image:url('Volume_on.png'); /* <<< Bạn thay icon loa bật ở đây */
  }
  #volumeBtn.dimmed {
    background-image:url('Volume_off.png'); /* <<< Bạn thay icon loa tắt ở đây */
    opacity:0.5;
  }

  #helpBtn {
    bottom:16px; right:16px;
    background-image:url('Help.png'); /* <<< Bạn thay icon help ở đây */
  }

  /* ===== SLIDESHOW LUẬT CHƠI ===== */
  #ruleScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 10002;
  }
  #ruleScreen.hidden { display:none; }
  #ruleScreen img {
    width:90vw;
    height:90vh;
    object-fit: contain;
    background:rgba(0,0,0,0.6); /* Làm tối nền phía sau */
    pointer-events:none;
  }

  /* ===== MÀN HÌNH THẮNG ===== */
  #winScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 10001;
  }
  #winScreen.hidden { display:none; }
  #winScreen img {
    width:80vw;
    height:80vh;
    object-fit: contain;
    background:rgba(0,0,0,0.5);
    pointer-events:none;
  }
  #resetBtn {
    margin-top:20px;
    padding:14px 32px;
    font-size:20px;
    border:none;
    border-radius:10px;
    background:white;
    cursor:pointer;
  }

  /* ===== DEBUG OVERLAY ===== */
  #debug {
    position:fixed;
    top:10px; left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.8);
    color:black;
    font-size:14px;
    padding:6px 10px;
    border-radius:6px;
    z-index:20000;
    max-width:90vw;
    word-wrap:break-word;
  }
</style>
</head>

<body>

<div id="introScreen">
  <button id="startARBtn">Bắt đầu AR</button>
</div>

<button id="volumeBtn" class="iconBtn"></button>
<button id="helpBtn" class="iconBtn"></button>

<div id="ruleScreen" class="hidden">
  <img id="ruleImage" src="LoiNgo.png"/> <!-- <<< Thay slide lời ngỏ của bạn ở đây -->
</div>

<div id="winScreen" class="hidden">
  <img src="Win.png"/> <!-- <<< Thay ảnh overlay thắng trận của bạn ở đây -->
  <button id="resetBtn">Chơi lại</button>
</div>

<div id="timer">0.0s</div>
<div id="debug">DEBUG: waiting...</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

/* ===== UI ELEMENTS ===== */
const introScreen = document.getElementById("introScreen");
const ruleScreen = document.getElementById("ruleScreen");
const ruleImage = document.getElementById("ruleImage");
const winScreen = document.getElementById("winScreen");
const debugUI = document.getElementById("debug");

/* ===== RULE SLIDES ===== */
const ruleSlides = ["LoiNgo.png", "LuatChoi.png"]; // <<< Bạn thay 2 file slide luật chơi của bạn tại đây
let ruleIndex = 0;

/* ===== BACKGROUND MUSIC ===== */
const bgMusic = new Audio("background.mp3"); // <<< Bạn thay file nhạc nền .mp3 của bạn ở đây
bgMusic.loop = true;
bgMusic.volume = 0.5;
bgMusic.muted = false;

/* Toggle volume */
const volumeBtn = document.getElementById("volumeBtn");
volumeBtn.addEventListener("touchstart", () => {
  bgMusic.muted = !bgMusic.muted;
  volumeBtn.classList.toggle("dimmed");
  log("Toggled volume: " + (bgMusic.muted ? "OFF" : "ON"));
});

/* Open rule slideshow */
document.getElementById("helpBtn").addEventListener("touchstart", () => {
  ruleIndex = 0;
  ruleScreen.classList.remove("hidden");
  ruleImage.src = ruleSlides[ruleIndex];
  introScreen.classList.add("hidden");
  log("Opened rule screen");
});

/* Next slide on any touch */
ruleScreen.addEventListener("touchstart", () => {
  ruleIndex++;
  if (ruleIndex < ruleSlides.length) {
    ruleImage.src = ruleSlides[ruleIndex];
    log("Slide → " + ruleSlides[ruleIndex]);
  } else {
    ruleScreen.classList.add("hidden");
    introScreen.classList.remove("hidden");
    log("Exited rule slideshow");
  }
});

/* ===== AR GAME LOGIC ===== */
let renderer, scene, camera, player;
let collected = 0;
let orbs = [];
let grid, ROWS = 15, COLS = 15;
let tileSize = 0.25 * 0.4; // 40% scale mặc định
let currentTile = [1,1];
let dir = [0,1];
let pendingDir = null;
let gameRunning = false;
let startTime = 0;

/* Debug logger */
function log(msg){
  console.log(msg);
  debugUI.innerText = "DEBUG: " + msg;
}

/* Start AR */
document.getElementById("startARBtn").addEventListener("touchstart", async () => {
  log("User tapped Start AR");
  await startARSession();
});

async function startARSession(){
  if(!navigator.xr){ log("No WebXR"); return; }

  try{
    const session = await navigator.xr.requestSession('immersive-ar', {
      requiredFeatures:['hit-test']
    });
    setupThree(session);
    introScreen.classList.add("hidden");
    bgMusic.play();
    log("AR Session started");
    gameRunning = true;
    gameRunning = true;
    gameRunning = true;
    startTime = performance.now();
  }catch(err){
    log("AR Session failed: " + err);
    alert("Không hỗ trợ AR immersive!");
  }
}

function setupThree(session){
  renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setSession(session);
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 50);
  scene.add(new THREE.HemisphereLight(1,1,1));

  generateMaze();
  spawnOrbs();
  loadPlayer();

  renderer.setAnimationLoop(renderLoop);
}

/* Generate more complex maze */
function generateMaze(){
  grid = Array.from({length:ROWS},()=>Array(COLS).fill(1));
  const dirs = [[0,2],[2,0],[0,-2],[-2,0]];
  const shuffle = a=>a.sort(()=>Math.random()-0.5);
  const carve=(r=1,c=1)=>{
    grid[r][c]=0;
    for(const[dr,dc]of shuffle([...dirs])){
      const nr=r+dr,nc=c+dc,br=r+dr/2,bc=c+dc/2;
      if(nr>0&&nc>0&&nr<ROWS-1&&nc<COLS-1&&grid[nr][nc]===1){
        grid[br][bc]=0; carve(nr,nc);
      }
    }
  };
  carve();
  for(let i=0;i<40;i++){
    const r=Math.floor(Math.random()*(ROWS-2))+1;
    const c=Math.floor(Math.random()*(COLS-2))+1;
    if(grid[r][c]===1) grid[r][c]=0;
  }
  log("Maze generated");
}

/* Spawn collectible orbs */
function spawnOrbs(){
  orbs.forEach(o=>scene.remove(o.mesh));
  orbs=[];
  collected=0;
  for(let i=0;i<20;i++){
    let r,c;
    do{
      r=Math.floor(Math.random()*ROWS);
      c=Math.floor(Math.random()*COLS);
    }while(grid[r][c]!==0);
    const orb=new THREE.Mesh(new THREE.SphereGeometry(0.02,12,12),new THREE.MeshStandardMaterial());
    orb.position.set((c-COLS/2)*tileSize,0.04,(r-ROWS/2)*tileSize);
    scene.add(orb);
    orbs.push({mesh:orb,r,c});
  }
  log("Orbs spawned");
}

/* Load player model */
function loadPlayer(){
  const loader=new GLTFLoader();
  loader.load("model.glb",gltf=>{ /* <<< Bạn thay model.glb nhân vật ở đây */
    player=gltf.scene;
    player.scale.set(0.08,0.08,0.08);
    scene.add(player);
    snapTo(currentTile[0],currentTile[1]);
    log("Player loaded");
  },undefined,err=>log("Player load error: "+err));
}

/* Snap movement like Pacman */
function snapTo(r,c){
  if(!player) return;
  player.position.x=(c-COLS/2)*tileSize;
  player.position.z=(r-ROWS/2)*tileSize;
  player.rotation.y=Math.atan2(-dir[1],dir[0]);
}

function updateMove(){
  if(!player) return;
  if(pendingDir){
    const [dr,dc]=pendingDir;
    if(grid[currentTile[0]+dr][currentTile[1]+dc]===0) dir=[dr,dc];
    pendingDir=null;
  }
  const nr=currentTile[0]+dir[0];
  const nc=currentTile[1]+dir[1];
  if(grid[nr][nc]===0){
    currentTile=[nr,nc];
    snapTo(nr,nc);
    eatOrb();
  }
}

function eatOrb(){
  for(const orb of orbs){
    if(orb.r===currentTile[0]&&orb.c===currentTile[1]&&orb.mesh.visible){
      orb.mesh.visible=false;
      collected++;
      log("Collected orb: "+collected);
      if(collected===orbs.length) winGame();
    }
  }
}

function winGame(){
  gameRunning=false;
  winScreen.classList.remove("hidden");
  log("Player won!");
}

/* Reset game */
document.getElementById("resetBtn").addEventListener("touchstart", resetGame);
function resetGame(){
  winScreen.classList.add("hidden");
  generateMaze();
  spawnOrbs();
  currentTile=[1,1];
  dir=[0,1];
  startTime=performance.now();
  gameRunning=true;
  log("Game reset");
}

function renderLoop(){
  if(gameRunning) updateMove();
  renderer.render(scene,camera);
}

/* Keyboard fallback for desktop testing */
window.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp") pendingDir=[-1,0];
  if(e.key==="ArrowDown") pendingDir=[1,0];
  if(e.key==="ArrowLeft") pendingDir=[0,-1];
  if(e.key==="ArrowRight") pendingDir=[0,1];
});
</script>

</body>
</html>
#v1.0.4