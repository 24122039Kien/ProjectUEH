<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WebAR Maze - Pacman Style</title>

<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }

  /* ===== INTRO SCREEN ===== */
  #introScreen {
    position: fixed;
    inset: 0;
    background-image: url('Background.png'); /* <<< THAY ẢNH NỀN INTRO Ở ĐÂY */
    background-size: cover;
    background-position: center;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index: 10000;
  }
  #introScreen.hidden { display:none; }

  /* ===== RULE SLIDESHOW ===== */
  #ruleScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 10002;
  }
  #ruleScreen.hidden { display:none; }
  #ruleScreen img {
    width:100vw;
    height:100vh;
    object-fit: contain;
    background:rgba(0,0,0,0.7);
    pointer-events:none;
  }

  /* ===== WIN SCREEN ===== */
  #winScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 10001;
  }
  #winScreen.hidden { display:none; }
  #winScreen img {
    width:100vw;
    height:100vh;
    object-fit: contain;
    background:rgba(0,0,0,0.6);
    pointer-events:none;
  }

  /* ===== ICON BUTTONS ===== */
  .iconBtn {
    position: fixed;
    width:48px; height:48px;
    border:none; background:none;
    background-size:60%;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    z-index:9999;
  }

  #volumeBtn {
    top:16px; right:16px;
    background-image:url('Volume_on.png'); /* <<< THAY ICON LOA BẬT Ở ĐÂY */
  }
  #volumeBtn.dimmed {
    background-image:url('Volume_off.png'); /* <<< THAY ICON LOA TẮT Ở ĐÂY */
    opacity:0.4;
  }

  #helpBtn {
    bottom:16px; right:16px;
    background-image:url('Help.png'); /* <<< THAY ICON LUẬT CHƠI Ở ĐÂY */
  }

  /* ===== TIMER UI ===== */
  #timer {
    position:fixed; top:16px; left:16px;
    font-size:20px; background:rgba(0,0,0,0.5);
    color:white; padding:6px 10px; border-radius:6px;
    z-index:9999;
  }
</style>
</head>

<body>

<!-- ===== INTRO OVERLAY ===== -->
<div id="introScreen">
  <img src="IntroTitle.png" style="width:260px;margin-bottom:20px"/> <!-- <<< THAY LOGO/TITLE Ở ĐÂY -->
  <button id="startBtn">Bắt đầu AR</button>
</div>

<!-- ===== BUTTONS ===== -->
<button id="volumeBtn" class="iconBtn"></button>
<button id="helpBtn" class="iconBtn"></button>

<!-- ===== RULE SLIDESHOW OVERLAY ===== -->
<div id="ruleScreen" class="hidden">
  <img id="ruleImage" src="LoiNgo.png"/> <!-- Slide ảnh luật chơi sẽ đổi src bằng JS -->
</div>

<!-- ===== WIN OVERLAY ===== -->
<div id="winScreen" class="hidden">
  <img src="Win.png"/> <!-- <<< THAY ẢNH OVERLAY THẮNG Ở ĐÂY -->
</div>

<div id="timer">0.0s</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

/* ===== GAME CONFIG ===== */
const SCALE_MAZE = 0.4;  // Maze scale 40%
const ROWS = 15;
const COLS = 15;

/* ===== MAZE GENERATION (DFS Backtracking) ===== */
let maze = Array.from({length:ROWS},()=>Array(COLS).fill(1));
const dirs = [[0,2],[2,0],[0,-2],[-2,0]];
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }
function carve(r=1,c=1){
  maze[r][c]=0;
  const d=[...dirs]; shuffle(d);
  for(const [dr,dc] of d){
    const nr=r+dr, nc=c+dc;
    const br=r+dr/2, bc=c+dc/2;
    if(nr>0&&nc>0&&nr<ROWS-1&&nc<COLS-1&&maze[nr][nc]===1){
      maze[br][bc]=0;
      carve(nr,nc);
    }
  }
}
carve();

/* ===== SETUP AR SCENE ===== */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,50);
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.xr.enabled=true;
document.body.appendChild(renderer.domElement);
document.body.appendChild(ARButton.createButton(renderer,{requiredFeatures:['hit-test']}));

const light=new THREE.HemisphereLight(1,1,1);
scene.add(light);

/* ===== BUILD MAZE WALLS ===== */
const mazeGroup=new THREE.Group();
scene.add(mazeGroup);
const tileSize=0.25 * SCALE_MAZE;
const wallThickness=0.045;
const wallHeight=0.20;

for(let r=0;r<ROWS;r++){
  for(let c=0;c<COLS;c++){
    if(maze[r][c]===1){
      const wall=new THREE.Mesh(
        new THREE.BoxGeometry(wallThickness,wallHeight,tileSize),
        new THREE.MeshStandardMaterial()
      );
      wall.position.set((c-COLS/2)*tileSize,wallHeight/2,(r-ROWS/2)*tileSize);
      mazeGroup.add(wall);
    }
  }
}

/* ===== SPAWN COLLECTIBLE ORBS ===== */
let orbs=[], collected=0;
const orbGeo=new THREE.SphereGeometry(0.02,12,12);
const orbMat=new THREE.MeshStandardMaterial({metalness:0.3,roughness:0.5});
const totalOrbs=20;

while(orbs.length<totalOrbs){
  const r=Math.floor(Math.random()*ROWS), c=Math.floor(Math.random()*COLS);
  if(maze[r][c]===0){
    const orb=new THREE.Mesh(orbGeo,orbMat);
    orb.position.set((c-COLS/2)*tileSize,0.04,(r-ROWS/2)*tileSize);
    scene.add(orb);
    orbs.push({mesh:orb,r,c});
  }
}

/* ===== LOAD PLAYER MODEL ===== */
const loader=new GLTFLoader();
let player;
loader.load("model.glb", gltf => {  /* <<< THAY MODEL .GLB NHÂN VẬT TẠI FILE MODEL.GLB TRONG CÙNG THƯ MỤC */
  player = gltf.scene;
  player.scale.set(0.12,0.12,0.12);
  scene.add(player);
  snapToTile(1,1);
  addArrow();
});

/* ===== DIRECTION ARROW (OPTIONAL INDICATOR) ===== */
let arrow;
function addArrow(){
  const geo=new THREE.ConeGeometry(0.02,0.06,8).rotateX(Math.PI/2);
  arrow=new THREE.Mesh(geo,new THREE.MeshStandardMaterial());
  scene.add(arrow);
}
function updateArrow(){
  if(!player||!arrow)return;
  arrow.position.set(player.position.x,0.12,player.position.z+0.05);
  arrow.rotation.z=Math.atan2(dir[0],dir[1]);
}

/* ===== PAC-MAN STYLE TILE MOVEMENT ===== */
let dir=[0,1], pendingDir=null;
let currentTile=[1,1];

function snapToTile(r,c){
  if(!player)return;
  player.position.x=(c-COLS/2)*tileSize;
  player.position.z=(r-ROWS/2)*tileSize;
  player.rotation.y = Math.atan2(dir[0], dir[1]);
}

function isFree(r,c){ return maze[r]?.[c]===0; }

function updateMove(dt){
  if(!player) return;
  if(pendingDir){
    const [dr,dc]=pendingDir;
    if(isFree(currentTile[0]+dr,currentTile[1]+dc)){ dir=[dr,dc]; }
    pendingDir=null;
  }
  const nr=currentTile[0]+dir[0], nc=currentTile[1]+dir[1];
  if(isFree(nr,nc)){ currentTile=[nr,nc]; snapToTile(nr,nc); checkOrb(); }
}

function checkOrb(){
  for(const o of orbs){
    if(o.r===currentTile[0] && o.c===currentTile[1] && o.mesh.visible){
      o.mesh.visible=false;
      collected++;
      if(collected===totalOrbs) winGame();
    }
  }
}

/* ===== WIN GAME ===== */
function winGame(){
  showWin();
  gameRunning=false;
}

const winScreen=document.getElementById("winScreen");
function showWin(){ winScreen.classList.remove("hidden"); }
winScreen.addEventListener("click",()=>{ winScreen.classList.add("hidden"); document.getElementById("introScreen").classList.remove("hidden"); });

/* ===== RULE SLIDESHOW ===== */
const ruleScreen=document.getElementById("ruleScreen");
const ruleImage=document.getElementById("ruleImage");
const ruleSlides=["LoiNgo.png","LuatChoi.png"]; /* <<< THAY 2 ẢNH SLIDESHOW Ở ĐÂY */

let ruleIndex=0;
ruleScreen.addEventListener("click",()=>{
  ruleIndex++;
  if(ruleIndex<ruleSlides.length) ruleImage.src=ruleSlides[ruleIndex];
  else ruleScreen.classList.add("hidden");
});

function showRules(){ ruleIndex=0; ruleScreen.classList.remove("hidden"); ruleImage.src=ruleSlides[0]; gameRunning=false; }
document.getElementById("helpBtn").addEventListener("click",showRules);

/* ===== MUSIC TOGGLE ===== */
const bgMusic = new Audio("background.mp3"); /* <<< THAY NHẠC NỀN .MP3 Ở ĐÂY, FILE MP3 ĐỂ TRONG CÙNG THƯ MỤC */
bgMusic.loop = true;
bgMusic.volume = 0.5;
const volumeBtn=document.getElementById("volumeBtn");
volumeBtn.addEventListener("click",()=>{ bgMusic.muted=!bgMusic.muted; volumeBtn.classList.toggle("dimmed"); });

/* ===== TIMER ===== */
let gameRunning=false, start=0, elapsed=0, last=performance.now();
document.getElementById("startBtn").onclick=()=>{ document.getElementById("introScreen").classList.add("hidden"); gameRunning=true; start=performance.now(); bgMusic.play(); };

function render(){
  const now=performance.now();
  const dt=(now-last)/1000;
  last=now;

  if(gameRunning){
    elapsed=(now-start);
    document.getElementById("timer").innerText=(elapsed/1000).toFixed(1)+"s";
    updateMove(dt);
    updateArrow();
  }
  renderer.render(scene,camera);
}
renderer.setAnimationLoop(render);
</script>

</body>
</html>

# v1.0.0