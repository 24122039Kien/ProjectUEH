<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WebAR Maze - Pacman Style</title>

<!-- Preload hình nền để tránh lag/flash trên iPhone -->
<link rel="preload" as="image" href="Background.png">

<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }

  /* ===== INTRO SCREEN ===== */
  #introScreen {
    position: fixed;
    inset: 0;
    background-image: url('Background.png'); /* <<< THAY ẢNH NỀN INTRO Ở ĐÂY */
    background-size: cover;
    background-position: center;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index: 10000;
  }
  #introScreen.hidden { display:none; }

  #startARBtn {
    padding:16px 40px;
    font-size:22px;
    border-radius:12px;
    border:none;
    cursor:pointer;
    background:white;
  }

  /* ===== ICON BUTTONS ===== */
  .iconBtn {
    position: fixed;
    width:64px; height:64px; /* bạn có thể chỉnh kích thước nút ở đây nếu cần */
    border:none; background:none;
    background-size:70%;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    z-index:10001; /* luôn cao hơn intro background để không bị che */
  }

  #volumeBtn {
    top:16px; right:16px;
    background-image:url('Volume_on.png'); /* <<< THAY ICON LOA BẬT Ở ĐÂY */
  }
  #volumeBtn.dimmed {
    background-image:url('Volume_off.png'); /* <<< THAY ICON LOA TẮT Ở ĐÂY */
    opacity:0.5;
  }

  #helpBtn {
    bottom:16px; right:16px;
    background-image:url('Help.png'); /* <<< THAY ICON HELP Ở ĐÂY */
  }

  /* ===== RULE SLIDESHOW ===== */
  #ruleScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 10002;
  }
  #ruleScreen.hidden { display:none; }
  #ruleScreen img {
    width:90vw;
    height:90vh;
    object-fit: contain;
    background:rgba(0,0,0,0.6); /* overlay tối phía sau khi xem slide */
    pointer-events:none;
  }

  /* ===== WIN SCREEN ===== */
  #winScreen {
    position: fixed;
    inset: 0;
    background:black;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index: 10003;
  }
  #winScreen.hidden { display:none; }
  #winScreen img {
    width:80vw;
    height:80vh;
    object-fit: contain;
    background:rgba(0,0,0,0.5);
    pointer-events:none;
  }
  #resetBtn {
    margin-top:20px;
    padding:14px 32px;
    font-size:20px;
    border:none;
    border-radius:10px;
    background:white;
    cursor:pointer;
  }

  /* ===== TIMER ===== */
  #timer {
    position:fixed; top:16px; left:16px;
    font-size:20px; background:rgba(0,0,0,0.5);
    color:white; padding:6px 10px; border-radius:6px;
    z-index:20000;
  }

  /* ===== DEBUG ===== */
  #debug {
    position:fixed;
    top:10px; left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.8);
    color:black;
    font-size:14px;
    padding:6px 10px;
    border-radius:6px;
    z-index:30000;
    max-width:90vw;
    word-wrap:break-word;
  }
</style>
</head>

<body>

<div id="introScreen">
  <button id="startARBtn">Bắt đầu AR</button>
</div>

<button id="volumeBtn" class="iconBtn"></button>
<button id="helpBtn" class="iconBtn"></button>

<div id="ruleScreen" class="hidden">
  <img id="ruleImage" src="LoiNgo.png"/> <!-- <<< THAY ẢNH SLIDE 1 Ở ĐÂY -->
</div>

<div id="winScreen" class="hidden">
  <img src="Win.png"/> <!-- <<< THAY ẢNH THẮNG Ở ĐÂY -->
  <button id="resetBtn">Chơi lại</button>
</div>

<div id="timer">0.0s</div>
<div id="debug">DEBUG: waiting...</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

/* ===== UI ===== */
const introScreen = document.getElementById("introScreen");
const ruleScreen = document.getElementById("ruleScreen");
const ruleImageUI = document.getElementById("ruleImage");
const winScreen = document.getElementById("winScreen");
const timerUI = document.getElementById("timer");
const debugUI = document.getElementById("debug");

/* ===== RULE SLIDES ===== */
const ruleSlides = ["LoiNgo.png", "LuatChoi.png"]; /* <<< THAY 2 ẢNH CỦA BẠN Ở ĐÂY */
let ruleIndex = 0;

/* ===== MUSIC ===== */
const bgMusic = new Audio("Audio.mp3"); /* <<< THAY FILE MP3 Ở ĐÂY */
bgMusic.loop = true;
bgMusic.volume = 0.5;
bgMusic.muted = false;

/* debug log */
function log(msg){
  console.log(msg);
  debugUI.innerText = "DEBUG: " + msg;
}

/* Toggle volume */
document.getElementById("volumeBtn").addEventListener("pointerdown", () => {
  bgMusic.muted = !bgMusic.muted;
  volumeBtn.classList.toggle("dimmed");
  log("Volume toggled: " + (bgMusic.muted ? "OFF" : "ON"));
});

/* Open rule slideshow */
document.getElementById("helpBtn").addEventListener("pointerdown", () => {
  ruleIndex = 0;
  ruleScreen.classList.remove("hidden");
  ruleImageUI.src = ruleSlides[ruleIndex];
  introScreen.classList.add("hidden");
  log("Rule screen opened");
});

/* Next slide on click anywhere */
ruleScreen.addEventListener("pointerdown", () => {
  ruleIndex++;
  if (ruleIndex < ruleSlides.length) {
    ruleImageUI.src = ruleSlides[ruleIndex];
    log("Slide → " + ruleSlides[ruleIndex]);
  } else {
    ruleScreen.classList.add("hidden");
    introScreen.classList.remove("hidden");
    log("Rule slideshow exited");
  }
});

/* Start AR Game */
document.getElementById("startARBtn").addEventListener("pointerdown", async () => {
  log("Start AR tapped");
  await startARSession();
});

let renderer, scene, camera, player;
let orbs = [];
let grid;
const TOTAL_ORBS = 20; // <<< tổng orb cần thu thập để thắng
const ROWS = 15, COLS = 15;
const SCALE = 0.4;
const tileSizeBase = 0.25 * SCALE;

async function startARSession(){
  if(!navigator.xr){ log("WebXR not found"); return; }
  try{
    const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures:['hit-test'] });
    setupThree(session);
    introScreen.classList.add("hidden");
    bgMusic.play();
  }catch(err){
    log("AR Session error: " + err);
    alert("Thiết bị không hỗ trợ AR Immersive");
  }
}

function setupThree(session){
  renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setSession(session);
  document.body.appendChild(renderer.domElement);
  document.body.appendChild(ARButton.createButton(renderer,{requiredFeatures:['hit-test']}));

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 50);
  scene.add(new THREE.HemisphereLight(1,1,1));

  generateMaze();
  spawnOrbs();
  loadPlayer();

  gameRunning = true;
  startTime = performance.now();
  renderer.setAnimationLoop(renderLoop);
}

function generateMaze(){
  grid = Array.from({length:ROWS},()=>Array(COLS).fill(1));
  const dirs = [[0,2],[2,0],[0,-2],[-2,0]];
  const shuffle = a=>a.sort(()=>Math.random()-0.5);
  const carve=(r=1,c=1)=>{
    grid[r][c]=0;
    for(const[dr,dc]of shuffle([...dirs])){
      const nr=r+dr,nc=c+dc,br=r+dr/2,bc=c+dc/2;
      if(nr>0&&nc>0&&nr<ROWS-1&&nc<COLS-1&&grid[nr][nc]===1){
        grid[br][bc]=0; carve(nr,nc);
      }
    }
  };
  carve();
  for(let i=0;i<40;i++){
    const r=Math.floor(Math.random()*(ROWS-2))+1;
    const c=Math.floor(Math.random()*(COLS-2))+1;
    if(grid[r][c]===1) grid[r][c]=0;
  }
}

function spawnOrbs(){
  if(scene && orbs.length){
    orbs.forEach(o => scene.remove(o.mesh));
  }
  orbs=[]; collected=0;
  for(let i=0;i<TOTAL_ORBS;i++){
    let r,c;
    do{ r=Math.floor(Math.random()*ROWS); c=Math.floor(Math.random()*COLS); }
    while(grid[r][c]!==0);
    const orb=new THREE.Mesh(new THREE.SphereGeometry(0.02,12,12),new THREE.MeshStandardMaterial());
    orb.position.set((c-COLS/2)*tileSizeBase,0.04,(r-ROWS/2)*tileSizeBase);
    scene.add(orb);
    orbs.push({mesh:orb,r,c});
  }
}

function loadPlayer(){
  const loader=new GLTFLoader();
  loader.load("model.glb",gltf=>{ /* <<< THAY MODEL NHÂN VẬT Ở ĐÂY */
    player=gltf.scene;
    player.scale.set(0.08,0.08,0.08);
    scene.add(player);
    currentTile=[1,1];
    dir=[0,1];
    snapTo(1,1);
  },undefined,err=>log("GLB load error: "+err));
}

function snapTo(r,c){
  if(!player) return;
  if(r<0||r>=ROWS||c<0||c>=COLS) return;
  player.position.x=(c-COLS/2)*tileSizeBase;
  player.position.z=(r-ROWS/2)*tileSizeBase;
  player.rotation.y=Math.atan2(-dir[1],dir[0]);
}

let collected=0, gameRunning=false, startTime=0;
let dir=[0,1], pendingDir=null, currentTile=[1,1];

function updateMove(){
  if(!player||!grid) return;
  const [dr,dc] = pendingDir ?? [0,0];
  if(pendingDir){
    const tr=currentTile[0]+dr, tc=currentTile[1]+dc;
    if(tr>=0&&tr<ROWS&&tc>=0&&tc<COLS&&grid[tr][tc]===0){
      dir=[dr,dc];
    }
    pendingDir=null;
  }
  const nr=currentTile[0]+dir[0], nc=currentTile[1]+dir[1];
  if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS && grid[nr][nc]===0){
    currentTile=[nr,nc];
    snapTo(nr,nc);
    eatOrb();
  }
}

function eatOrb(){
  if(!Array.isArray(orbs)) return;
  for(const orb of orbs){
    if(orb.r===currentTile[0]&&orb.c===currentTile[1]&&orb.mesh.visible){
      orb.mesh.visible=false;
      collected++;
      if(collected===TOTAL_ORBS) winGame();
    }
  }
}

function winGame(){
  gameRunning=false;
  winScreen.classList.remove("hidden");
}

document.getElementById("resetBtn").addEventListener("pointerdown",()=>{
  winScreen.classList.add("hidden");
  spawnOrbs();
  collected=0;
  currentTile=[1,1];
  dir=[0,1];
  startTime=performance.now();
  gameRunning=true;
  snapTo(1,1);
});

function renderLoop(){
  if(gameRunning) updateMove();
  if(renderer && scene && camera) renderer.render(scene,camera);
}

/* Desktop test keyboard */
window.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp") pendingDir=[-1,0];
  if(e.key==="ArrowDown") pendingDir=[1,0];
  if(e.key==="ArrowLeft") pendingDir=[0,-1];
  if(e.key==="ArrowRight") pendingDir=[0,1];
});
</script>

</body>
</html>
#v1.0.5