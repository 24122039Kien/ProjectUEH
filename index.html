<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>
<title>Hành Trình Linh Nghê - Debug</title>

<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

<style>
  body { margin:0; overflow:hidden; font-family: sans-serif; user-select: none; -webkit-user-select: none; }

  /* --- UI CSS --- */
  #introScreen {
    position: fixed; inset: 0;
    background-image: url('Background.png'); /* Đảm bảo tên file đúng 100% */
    background-size: cover; background-position: center;
    background-color: #ffeaa7; /* Màu nền dự phòng nếu ảnh lỗi */
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    z-index: 100;
  }
  
  /* Nút Bắt đầu */
  #startARBtn {
    margin-top: 150px; 
    padding: 15px 40px;
    font-size: 20px; font-weight: bold;
    color: #006266; background: rgba(255,255,255,0.95);
    border: 3px solid #006266; border-radius: 50px;
    cursor: pointer; z-index: 101;
    pointer-events: auto; /* Bắt buộc để nhận cảm ứng */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  #startARBtn:active { transform: scale(0.95); background: #eee; }

  /* Nút Icon */
  .iconBtn {
    position: fixed; width:60px; height:60px;
    background-color: transparent; border:none;
    background-size: contain; background-repeat:no-repeat; background-position:center;
    z-index: 102; cursor:pointer; pointer-events: auto;
  }
  #volumeBtn { top:20px; right:20px; background-image:url('Volume_on.png'); }
  #helpBtn { bottom:20px; right:20px; background-image:url('Help.png'); }

  /* Screens */
  .overlay-screen {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    display:none; justify-content:center; align-items:center;
    z-index: 200;
  }
  .overlay-screen img { max-width: 95%; max-height: 90%; }
  .active { display: flex !important; }

  /* BẢNG BÁO LỖI (Quan trọng để Debug trên điện thoại) */
  #console-log {
    position: fixed; top: 0; left: 0; width: 100%; height: 150px;
    background: rgba(0,0,0,0.7); color: #00ff00;
    font-family: monospace; font-size: 10px;
    overflow-y: scroll; z-index: 9999;
    padding: 5px; pointer-events: none;
    border-bottom: 2px solid red;
  }
</style>
</head>

<body>

<div id="console-log">Hệ thống khởi động...<br></div>

<div id="introScreen">
  <button id="startARBtn" onclick="startGame()">Bắt đầu AR</button>
</div>

<button id="volumeBtn" class="iconBtn" onclick="toggleMute()"></button>
<button id="helpBtn" class="iconBtn" onclick="showHelp()"></button>

<div id="ruleScreen" class="overlay-screen" onclick="nextSlide()">
  <img id="ruleImage" src="LoiNgo.png" />
</div>

<div id="winScreen" class="overlay-screen">
  <img src="Win.png" />
  <button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; font-size:20px;">Chơi lại</button>
</div>

<script>
  // Hàm in lỗi ra màn hình
  function log(msg) {
    const box = document.getElementById('console-log');
    box.innerHTML += `> ${msg}<br>`;
    box.scrollTop = box.scrollHeight;
    console.log(msg);
  }

  // Bắt tất cả lỗi hệ thống
  window.onerror = function(message, source, lineno, colno, error) {
    log(`<span style="color:red">ERROR: ${message} (Line: ${lineno})</span>`);
  };

  log("UI Script Loaded.");

  // Logic Nút Help
  const ruleScreen = document.getElementById('ruleScreen');
  const ruleImage = document.getElementById('ruleImage');
  const slides = ["LoiNgo.png", "LuatChoi.png"];
  let slideIndex = 0;

  function showHelp() {
    log("Nút Help được nhấn");
    slideIndex = 0;
    ruleImage.src = slides[0];
    ruleScreen.classList.add('active');
  }

  function nextSlide() {
    slideIndex++;
    if(slideIndex < slides.length) {
      ruleImage.src = slides[slideIndex];
    } else {
      ruleScreen.classList.remove('active');
    }
  }

  // Logic Nút Volume
  const bgMusic = new Audio("Audio.mp3");
  bgMusic.loop = true;
  let isMuted = false;

  function toggleMute() {
    log("Nút Volume được nhấn");
    isMuted = !isMuted;
    bgMusic.muted = isMuted;
    const btn = document.getElementById('volumeBtn');
    btn.style.opacity = isMuted ? "0.5" : "1";
    
    // Thử phát nhạc nếu chưa phát
    if(!isMuted) bgMusic.play().catch(e => log("Chặn Auto-play: Cần tương tác trước."));
  }

  // Logic Nút Bắt đầu (Phần UI)
  function startGame() {
    log("Nút Bắt đầu AR được nhấn!");
    document.getElementById('introScreen').style.display = 'none';
    bgMusic.play().catch(e => log("Không thể phát nhạc: " + e));
    
    // Gọi hàm khởi động AR (được định nghĩa ở script module bên dưới)
    if (window.initARSession) {
      window.initARSession();
    } else {
      log('<span style="color:red">LỖI: Module AR chưa tải xong hoặc bị chặn!</span>');
      alert("Lỗi tải Game. Vui lòng kiểm tra kết nối mạng hoặc thử lại.");
    }
  }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// In ra log để biết module đã chạy
const logBox = document.getElementById('console-log');
function logModule(msg) {
    box.innerHTML += `[AR]: ${msg}<br>`;
}

// Global Variables
let renderer, scene, camera, mazeGroup, player;
let grid = [], orbs = [];
const ROWS=15, COLS=15, TILE_SIZE=0.2;
let moveState='IDLE';
let currentTile={r:1, c:1}, targetTile={r:1, c:1};
let currentDir={r:0, c:0}, nextDir={r:0, c:0};

// Gắn hàm initAR vào window để nút HTML gọi được
window.initARSession = async function() {
    log("Đang yêu cầu WebXR Session...");
    
    if (!navigator.xr) {
        log("THIẾT BỊ KHÔNG HỖ TRỢ WEBXR");
        alert("Điện thoại này không hỗ trợ WebXR (AR trên web). Hãy thử dùng Chrome trên Android hoặc Cài đặt WebXR Viewer trên iOS.");
        // Vẫn chạy fallback để test
        setupThree(null);
        return;
    }

    try {
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local'] // 'hit-test' thường gây lỗi trên iOS cũ, dùng 'local' an toàn hơn
        });
        setupThree(session);
    } catch (e) {
        log("LỖI KHỞI ĐỘNG AR: " + e.message);
        alert("Không thể vào chế độ AR: " + e.message);
        // Fallback
        setupThree(null);
    }
};

function setupThree(session) {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
    
    renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    
    if(session) {
        renderer.xr.setSession(session);
    } else {
        // Setup giả lập cho PC/Điện thoại không hỗ trợ
        camera.position.set(0, 2, 2);
        camera.lookAt(0,0,0);
        scene.background = new THREE.Color(0x333333);
    }
    
    document.body.appendChild(renderer.domElement);
    
    // Ánh sáng
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
    const dl = new THREE.DirectionalLight(0xffffff, 0.5);
    dl.position.set(2,5,2);
    scene.add(dl);
    
    // Group game
    mazeGroup = new THREE.Group();
    mazeGroup.position.set(0, -0.5, -1.0); // Đặt trước mặt
    scene.add(mazeGroup);
    
    createMaze();
    loadPlayer();
    
    renderer.setAnimationLoop(render);
    
    // Touch event
    setupTouch();
}

function createMaze() {
    // Tạo sàn
    const fGeo = new THREE.PlaneGeometry(TILE_SIZE, TILE_SIZE);
    const fMat = new THREE.MeshBasicMaterial({color: 0x222222});
    const wGeo = new THREE.BoxGeometry(TILE_SIZE, TILE_SIZE, TILE_SIZE);
    const wMat = new THREE.MeshStandardMaterial({color: 0x8e44ad});
    
    // Grid đơn giản (Tường viền, trong rỗng)
    for(let r=0; r<ROWS; r++){
        grid[r] = [];
        for(let c=0; c<COLS; c++){
            let isWall = (r==0 || r==ROWS-1 || c==0 || c==COLS-1 || Math.random()<0.2);
            if(r==1 && c==1) isWall=false; // Start point
            
            grid[r][c] = isWall ? 1 : 0;
            
            let x = (c-COLS/2)*TILE_SIZE;
            let z = (r-ROWS/2)*TILE_SIZE;
            
            if(isWall){
                let m = new THREE.Mesh(wGeo, wMat);
                m.position.set(x, TILE_SIZE/2, z);
                mazeGroup.add(m);
            } else {
                let f = new THREE.Mesh(fGeo, fMat);
                f.rotation.x = -Math.PI/2;
                f.position.set(x, 0, z);
                mazeGroup.add(f);
            }
        }
    }
}

function loadPlayer() {
    const loader = new GLTFLoader();
    loader.load('model.glb', (gltf)=>{
        player = gltf.scene;
        player.scale.set(0.1, 0.1, 0.1);
        mazeGroup.add(player);
        updatePos();
    }, undefined, (e)=>{
        log("Lỗi load model.glb (Dùng hộp thay thế): " + e);
        // Fallback box
        player = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), new THREE.MeshBasicMaterial({color:'yellow'}));
        mazeGroup.add(player);
        updatePos();
    });
}

function updatePos(){
    if(!player) return;
    let x = (currentTile.c-COLS/2)*TILE_SIZE;
    let z = (currentTile.r-ROWS/2)*TILE_SIZE;
    player.position.set(x, 0.05, z);
}

// Logic di chuyển
function render() {
    if(moveState === 'MOVING' && player) {
        let destX = (targetTile.c - COLS/2)*TILE_SIZE;
        let destZ = (targetTile.r - ROWS/2)*TILE_SIZE;
        let target = new THREE.Vector3(destX, 0.05, destZ);
        
        if(player.position.distanceTo(target) < 0.05) {
            player.position.copy(target);
            currentTile = {...targetTile};
            moveState = 'IDLE';
        } else {
            let dir = new THREE.Vector3().subVectors(target, player.position).normalize();
            player.position.addScaledVector(dir, 0.05);
        }
    } else if(moveState === 'IDLE') {
        // Check input logic here if needed
        if(nextDir.r!==0 || nextDir.c!==0) {
           let nr = currentTile.r + nextDir.r;
           let nc = currentTile.c + nextDir.c;
           if(grid[nr] && grid[nr][nc] === 0) {
               targetTile = {r:nr, c:nc};
               moveState = 'MOVING';
               player.lookAt((nc-COLS/2)*TILE_SIZE, 0.05, (nr-ROWS/2)*TILE_SIZE);
           }
           nextDir={r:0,c:0};
        }
    }
    
    renderer.render(scene, camera);
}

function setupTouch() {
    let startX, startY;
    window.addEventListener('touchstart', e=>{
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    window.addEventListener('touchend', e=>{
        let dx = e.changedTouches[0].clientX - startX;
        let dy = e.changedTouches[0].clientY - startY;
        if(Math.abs(dx) > Math.abs(dy)) nextDir = dx>0 ? {r:0,c:1} : {r:0,c:-1};
        else nextDir = dy>0 ? {r:1,c:0} : {r:-1,c:0};
    });
}

// Báo cáo tải thành công
document.getElementById('console-log').innerHTML += "MODULE AR ĐÃ TẢI XONG.<br>";
</script>
</body>
</html>
#v1.0.8 viet tach rieng thanh 2 phan