<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>
<title>Hành Trình Linh Nghê - AR Placement</title>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<style>
  body { margin:0; overflow:hidden; font-family: sans-serif; user-select: none; -webkit-user-select: none; }

  /* UI CSS */
  #introScreen {
    position: fixed; inset: 0;
    background-image: url('Background.png'); 
    background-size: cover; background-position: center;
    background-color: #ffeaa7;
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    z-index: 100;
  }
  
  #startARBtn {
    margin-top: 150px; 
    padding: 15px 40px; font-size: 20px; font-weight: bold;
    color: #006266; background: rgba(255,255,255,0.95);
    border: 3px solid #006266; border-radius: 50px;
    cursor: pointer; z-index: 101; pointer-events: auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  #startARBtn:active { transform: scale(0.95); }

  .iconBtn {
    position: fixed; width:60px; height:60px;
    background: transparent; border:none;
    background-size: contain; background-repeat:no-repeat; background-position:center;
    z-index: 102; cursor:pointer;
  }
  #volumeBtn { top:20px; right:20px; background-image:url('Volume_on.png'); }
  #helpBtn { bottom:20px; right:20px; background-image:url('Help.png'); }

  .overlay-screen {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    display:none; justify-content:center; align-items:center;
    z-index: 200;
  }
  .overlay-screen img { max-width: 95%; max-height: 90%; }
  .active { display: flex !important; }

  /* Hướng dẫn đặt sàn */
  #ar-guide {
    position: fixed; bottom: 50px; left:0; width:100%;
    text-align: center; color: white; font-size: 16px;
    text-shadow: 1px 1px 2px black; pointer-events: none;
    display: none; z-index: 999;
  }
</style>
</head>

<body>

<div id="ar-guide">Di chuyển máy từ từ để tìm mặt sàn...</div>

<div id="introScreen">
  <button id="startARBtn" onclick="startGame()">Bắt đầu AR</button>
</div>

<button id="volumeBtn" class="iconBtn" onclick="toggleMute()"></button>
<button id="helpBtn" class="iconBtn" onclick="showHelp()"></button>

<div id="ruleScreen" class="overlay-screen" onclick="nextSlide()">
  <img id="ruleImage" src="LoiNgo.png" />
</div>

<div id="winScreen" class="overlay-screen">
  <img src="Win.png" />
  <button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; font-size:20px;">Chơi lại</button>
</div>

<script>
  // UI Logic
  const ruleScreen = document.getElementById('ruleScreen');
  const ruleImage = document.getElementById('ruleImage');
  const slides = ["LoiNgo.png", "LuatChoi.png"];
  let slideIndex = 0;

  function showHelp() {
    slideIndex = 0;
    ruleImage.src = slides[0];
    ruleScreen.classList.add('active');
  }

  function nextSlide() {
    slideIndex++;
    if(slideIndex < slides.length) {
      ruleImage.src = slides[slideIndex];
    } else {
      ruleScreen.classList.remove('active');
    }
  }

  const bgMusic = new Audio("Audio.mp3");
  bgMusic.loop = true;
  let isMuted = false;

  function toggleMute() {
    isMuted = !isMuted;
    bgMusic.muted = isMuted;
    document.getElementById('volumeBtn').style.opacity = isMuted ? "0.5" : "1";
    if(!isMuted) bgMusic.play().catch(e=>{});
  }

  function startGame() {
    bgMusic.play().catch(e=>{});
    document.getElementById('introScreen').style.display = 'none';
    if (window.initARSession) {
      window.initARSession();
    } else {
      alert("Lỗi: Module AR chưa sẵn sàng!");
    }
  }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// Global Vars
let renderer, scene, camera;
let mazeGroup, player, reticle;
let hitTestSource = null;
let hitTestSourceRequested = false;
let isMazePlaced = false; // Cờ kiểm tra đã đặt mê cung chưa

// Game Logic Vars
let grid = [], orbs = [];
const ROWS=15, COLS=15, TILE_SIZE=0.15; // Giảm size chút cho dễ đặt
let moveState='IDLE';
let currentTile={r:1, c:1}, targetTile={r:1, c:1};
let currentDir={r:0, c:0}, nextDir={r:0, c:0};

// --- AR INITIALIZATION ---
window.initARSession = async function() {
    if (!navigator.xr) {
        alert("Thiết bị không hỗ trợ WebXR"); return;
    }
    try {
        // Yêu cầu 'hit-test' để tìm mặt sàn
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local', 'hit-test'] 
        });
        setupThree(session);
    } catch (e) {
        alert("Lỗi mở AR: " + e.message);
    }
};

function setupThree(session) {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

    renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    renderer.xr.setSession(session);
    renderer.xr.setReferenceSpaceType('local');
    document.body.appendChild(renderer.domElement);

    // Light
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
    const dl = new THREE.DirectionalLight(0xffffff, 0.5);
    dl.position.set(2,5,2);
    scene.add(dl);

    // 1. TẠO VÒNG TRÒN ĐỊNH VỊ (RETICLE)
    reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
        new THREE.MeshBasicMaterial({ color: 0xffffff })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // 2. TẠO MÊ CUNG (Ban đầu ẩn đi)
    mazeGroup = new THREE.Group();
    mazeGroup.visible = false; // Chưa đặt thì chưa hiện
    scene.add(mazeGroup);

    createMaze();
    loadPlayer();

    // Sự kiện chạm màn hình (Select)
    session.addEventListener('select', onSelect);

    // Hiện hướng dẫn
    document.getElementById('ar-guide').style.display = 'block';

    renderer.setAnimationLoop(render);
    setupTouch(); // Vuốt tay
}

// Xử lý khi chạm màn hình
function onSelect() {
    if (reticle.visible && !isMazePlaced) {
        // Đặt mê cung tại vị trí vòng tròn
        mazeGroup.position.setFromMatrixPosition(reticle.matrix);
        mazeGroup.visible = true;
        isMazePlaced = true;
        
        // Ẩn vòng tròn và hướng dẫn
        reticle.visible = false;
        document.getElementById('ar-guide').style.display = 'none';
    }
}

// --- RENDER LOOP ---
function render(timestamp, frame) {
    if (frame) {
        // 1. Logic Hit-Test (Tìm mặt sàn)
        if (!isMazePlaced) {
            const referenceSpace = renderer.xr.getReferenceSpace();
            const session = renderer.xr.getSession();

            if (hitTestSourceRequested === false) {
                session.requestReferenceSpace('viewer').then((refSpace) => {
                    session.requestHitTestSource({ space: refSpace }).then((source) => {
                        hitTestSource = source;
                    });
                });
                session.addEventListener('end', () => {
                    hitTestSourceRequested = false;
                    hitTestSource = null;
                });
                hitTestSourceRequested = true;
            }

            if (hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    reticle.visible = true;
                    reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    document.getElementById('ar-guide').innerText = "Chạm màn hình để đặt Game";
                } else {
                    reticle.visible = false;
                    document.getElementById('ar-guide').innerText = "Di chuyển máy từ từ để tìm mặt sàn...";
                }
            }
        }

        // 2. Logic Game (Chỉ chạy khi đã đặt mê cung)
        if (isMazePlaced && player) {
            updatePlayerMovement();
        }
    }
    renderer.render(scene, camera);
}

// --- GAME LOGIC ---
function createMaze() {
    // Sàn của mê cung
    const fGeo = new THREE.PlaneGeometry(TILE_SIZE, TILE_SIZE);
    const fMat = new THREE.MeshBasicMaterial({color: 0x222222, transparent:true, opacity:0.8});
    // Tường
    const wGeo = new THREE.BoxGeometry(TILE_SIZE, TILE_SIZE, TILE_SIZE);
    const wMat = new THREE.MeshStandardMaterial({color: 0x8e44ad});

    for(let r=0; r<ROWS; r++){
        grid[r] = [];
        for(let c=0; c<COLS; c++){
            let isWall = (r==0 || r==ROWS-1 || c==0 || c==COLS-1 || Math.random()<0.2);
            if(r==1 && c==1) isWall=false; 
            
            grid[r][c] = isWall ? 1 : 0;
            
            let x = (c - COLS/2) * TILE_SIZE;
            let z = (r - ROWS/2) * TILE_SIZE;
            
            if(isWall){
                let m = new THREE.Mesh(wGeo, wMat);
                m.position.set(x, TILE_SIZE/2, z);
                mazeGroup.add(m);
            } else {
                let f = new THREE.Mesh(fGeo, fMat);
                f.rotation.x = -Math.PI/2;
                f.position.set(x, 0, z);
                mazeGroup.add(f);
            }
        }
    }
}

function loadPlayer() {
    const loader = new GLTFLoader();
    loader.load('model.glb', (gltf)=>{
        player = gltf.scene;
        player.scale.set(0.08, 0.08, 0.08); // Scale nhỏ lại cho hợp AR
        mazeGroup.add(player);
        updatePlayerVisualPos();
    }, undefined, (e)=>{
        // Fallback
        player = new THREE.Mesh(new THREE.BoxGeometry(0.08,0.08,0.08), new THREE.MeshStandardMaterial({color:'yellow'}));
        mazeGroup.add(player);
        updatePlayerVisualPos();
    });
}

function updatePlayerVisualPos(){
    if(!player) return;
    let x = (currentTile.c - COLS/2) * TILE_SIZE;
    let z = (currentTile.r - ROWS/2) * TILE_SIZE;
    player.position.set(x, 0, z);
}

function updatePlayerMovement() {
    if(moveState === 'MOVING') {
        let destX = (targetTile.c - COLS/2)*TILE_SIZE;
        let destZ = (targetTile.r - ROWS/2)*TILE_SIZE;
        let target = new THREE.Vector3(destX, 0, destZ);
        
        if(player.position.distanceTo(target) < 0.01) {
            player.position.copy(target);
            currentTile = {...targetTile};
            moveState = 'IDLE';
        } else {
            let dir = new THREE.Vector3().subVectors(target, player.position).normalize();
            player.position.addScaledVector(dir, 0.03); // Tốc độ di chuyển
        }
    } else if(moveState === 'IDLE') {
        if(nextDir.r!==0 || nextDir.c!==0) {
           let nr = currentTile.r + nextDir.r;
           let nc = currentTile.c + nextDir.c;
           if(grid[nr] && grid[nr][nc] === 0) {
               targetTile = {r:nr, c:nc};
               moveState = 'MOVING';
               player.lookAt((nc-COLS/2)*TILE_SIZE, 0, (nr-ROWS/2)*TILE_SIZE);
           }
           nextDir={r:0,c:0};
        }
    }
}

function setupTouch() {
    let startX, startY;
    window.addEventListener('touchstart', e=>{
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    window.addEventListener('touchend', e=>{
        if(!isMazePlaced) return; // Chưa đặt game thì không cho vuốt
        
        let dx = e.changedTouches[0].clientX - startX;
        let dy = e.changedTouches[0].clientY - startY;
        if(Math.abs(dx) > Math.abs(dy)) nextDir = dx>0 ? {r:0,c:1} : {r:0,c:-1};
        else nextDir = dy>0 ? {r:1,c:0} : {r:-1,c:0};
    });
}
</script>
</body>
</html>
#v1.0.10 sửa lại logic game